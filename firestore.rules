rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }

    // Helper function to check if user is the owner
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Users collection
    match /users/{userId} {
      // Anyone can read user profiles
      allow read: if isSignedIn();
      // Users can only write to their own profile
      allow write: if isOwner(userId);
    }

    // Workspaces collection
    match /workspaces/{workspaceId} {
      // Users can read workspaces they're members of or own
      allow read: if isSignedIn() && (
        request.auth.uid == resource.data.ownerId ||
        request.auth.uid in resource.data.members
      );
      // Users can create workspaces
      allow create: if isSignedIn() && request.auth.uid == request.resource.data.ownerId;
      // Owners can update/delete workspaces
      // Users accepting invites can add themselves to members array
      allow update: if isSignedIn() && (
        request.auth.uid == resource.data.ownerId ||
        (
          // Allow if only members field is being updated AND user is adding themselves
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['members']) &&
          request.auth.uid in request.resource.data.members &&
          !(request.auth.uid in resource.data.members)
        )
      );
      allow delete: if isSignedIn() && request.auth.uid == resource.data.ownerId;
    }

    // Channels collection
    match /channels/{channelId} {
      // Users can read channels in workspaces they're members of
      allow read: if isSignedIn();
      // Any authenticated user can create channels
      allow create: if isSignedIn();
      // Channel creators or workspace owners can update/delete channels
      allow update, delete: if isSignedIn() && (
        request.auth.uid == resource.data.createdBy ||
        exists(/databases/$(database)/documents/workspaces/$(resource.data.workspaceId)) &&
        get(/databases/$(database)/documents/workspaces/$(resource.data.workspaceId)).data.ownerId == request.auth.uid
      );
    }

    // Messages collection
    match /messages/{messageId} {
      // Users can read messages
      allow read: if isSignedIn();
      // Any authenticated user can create messages
      allow create: if isSignedIn() && request.auth.uid == request.resource.data.userId;
      // Users can update/delete their own messages
      allow update, delete: if isSignedIn() && request.auth.uid == resource.data.userId;
    }

    // Workspace invites collection
    match /workspace-invites/{inviteId} {
      // Users can read invites if:
      // - Sent to their email
      // - They created the invite
      // - They own or are members of the workspace (for duplicate checking)
      allow read: if isSignedIn() && (
        request.auth.token.email.lower() == resource.data.email ||
        request.auth.uid == resource.data.invitedBy ||
        exists(/databases/$(database)/documents/workspaces/$(resource.data.workspaceId)) &&
        (
          get(/databases/$(database)/documents/workspaces/$(resource.data.workspaceId)).data.ownerId == request.auth.uid ||
          request.auth.uid in get(/databases/$(database)/documents/workspaces/$(resource.data.workspaceId)).data.members
        )
      );
      // Authenticated users can create invites if they're workspace owner or member
      allow create: if isSignedIn() &&
        request.auth.uid == request.resource.data.invitedBy &&
        exists(/databases/$(database)/documents/workspaces/$(request.resource.data.workspaceId)) &&
        (
          get(/databases/$(database)/documents/workspaces/$(request.resource.data.workspaceId)).data.ownerId == request.auth.uid ||
          request.auth.uid in get(/databases/$(database)/documents/workspaces/$(request.resource.data.workspaceId)).data.members
        );
      // Users can update invites sent to their email (for accepting/declining)
      allow update: if isSignedIn() && (
        request.auth.token.email.lower() == resource.data.email ||
        request.auth.uid == resource.data.invitedBy
      );
      // Only the person who created the invite can delete it
      allow delete: if isSignedIn() && request.auth.uid == resource.data.invitedBy;
    }
  }
}
