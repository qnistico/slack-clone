rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }

    // Helper function to check if user is the owner
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Users collection
    match /users/{userId} {
      // Anyone can read user profiles
      allow read: if isSignedIn();
      // Users can only write to their own profile
      allow write: if isOwner(userId);
    }

    // Workspaces collection
    match /workspaces/{workspaceId} {
      // Demo Workspace ID - accessible by all authenticated users
      function isDemoWorkspace() {
        return workspaceId == 'CF5VUKMfiADwrEqSvHTy';
      }

      // Users can read workspaces if they:
      // - Own the workspace
      // - Are members of the workspace
      // - It's the Demo Workspace (accessible to all)
      // Note: Reading workspace when accepting invite is allowed via the get() in the invite update rule
      allow read: if isSignedIn() && (
        isDemoWorkspace() ||
        request.auth.uid == resource.data.ownerId ||
        request.auth.uid in resource.data.members
      );
      // Users can create workspaces
      allow create: if isSignedIn() && request.auth.uid == request.resource.data.ownerId;
      // Owners can update/delete workspaces
      // Users accepting invites can add themselves to members array
      // Any user can add themselves to the Demo Workspace
      allow update: if isSignedIn() && (
        request.auth.uid == resource.data.ownerId ||
        request.auth.uid == request.resource.data.ownerId ||
        (
          // Allow if only members field is being updated
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['members']) &&
          // AND user is in the new members list but not in the old one (they're adding themselves)
          request.auth.uid in request.resource.data.members &&
          !(request.auth.uid in resource.data.get('members', []))
        )
      );
      allow delete: if isSignedIn() && request.auth.uid == resource.data.ownerId;
    }

    // Channels collection
    match /channels/{channelId} {
      // Users can read channels in workspaces they're members of
      allow read: if isSignedIn();
      // Any authenticated user can create channels
      allow create: if isSignedIn();
      // Channel creators or workspace owners can update/delete channels
      // Users can add themselves to non-private channels
      allow update: if isSignedIn() && (
        request.auth.uid == resource.data.createdBy ||
        (
          exists(/databases/$(database)/documents/workspaces/$(resource.data.workspaceId)) &&
          get(/databases/$(database)/documents/workspaces/$(resource.data.workspaceId)).data.ownerId == request.auth.uid
        ) ||
        (
          // Allow if only members field is being updated
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['members']) &&
          // AND channel is not private
          !resource.data.isPrivate &&
          // AND user is in the new members list but not in the old one (they're adding themselves)
          request.auth.uid in request.resource.data.members &&
          !(request.auth.uid in resource.data.get('members', []))
        )
      );
      allow delete: if isSignedIn() && (
        request.auth.uid == resource.data.createdBy ||
        exists(/databases/$(database)/documents/workspaces/$(resource.data.workspaceId)) &&
        get(/databases/$(database)/documents/workspaces/$(resource.data.workspaceId)).data.ownerId == request.auth.uid
      );
    }

    // Messages collection
    match /messages/{messageId} {
      // Users can read messages
      allow read: if isSignedIn();
      // Any authenticated user can create messages
      // Also allow bot messages (userId starts with "bot-") for demo purposes
      allow create: if isSignedIn() && (
        request.auth.uid == request.resource.data.userId ||
        request.resource.data.userId.matches('bot-.*')
      );
      // Users can delete their own messages
      // Also allow deleting bot messages for demo cleanup
      allow delete: if isSignedIn() && (
        request.auth.uid == resource.data.userId ||
        resource.data.userId.matches('bot-.*')
      );
      // Users can update their own messages (edit content)
      // OR any user can update reactions on any message
      allow update: if isSignedIn() && (
        // Owner can update anything on their message
        request.auth.uid == resource.data.userId ||
        // Anyone can update only the reactions field
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['reactions'])
      );
    }

    // Workspace invites collection
    match /workspace-invites/{inviteId} {
      // Users can read invites if:
      // - Sent to their email
      // - They created the invite
      // - They own or are members of the workspace (for duplicate checking)
      allow read: if isSignedIn() && (
        request.auth.token.email.lower() == resource.data.email ||
        request.auth.uid == resource.data.invitedBy ||
        exists(/databases/$(database)/documents/workspaces/$(resource.data.workspaceId)) &&
        (
          get(/databases/$(database)/documents/workspaces/$(resource.data.workspaceId)).data.ownerId == request.auth.uid ||
          request.auth.uid in get(/databases/$(database)/documents/workspaces/$(resource.data.workspaceId)).data.members
        )
      );
      // Authenticated users can create invites if they're workspace owner or member
      allow create: if isSignedIn() &&
        request.auth.uid == request.resource.data.invitedBy &&
        exists(/databases/$(database)/documents/workspaces/$(request.resource.data.workspaceId)) &&
        (
          get(/databases/$(database)/documents/workspaces/$(request.resource.data.workspaceId)).data.ownerId == request.auth.uid ||
          request.auth.uid in get(/databases/$(database)/documents/workspaces/$(request.resource.data.workspaceId)).data.members
        );
      // Users can update invites sent to their email (for accepting/declining)
      allow update: if isSignedIn() && (
        request.auth.token.email.lower() == resource.data.email ||
        request.auth.uid == resource.data.invitedBy
      );
      // Only the person who created the invite can delete it
      allow delete: if isSignedIn() && request.auth.uid == resource.data.invitedBy;
    }

    // Direct Messages collection
    match /directMessages/{dmId} {
      // Users can read DMs if they are a participant
      // Also allow reading DMs that include bot participants
      allow read: if isSignedIn() && (
        request.auth.uid in resource.data.participants ||
        resource.data.participants[0].matches('bot-.*') ||
        resource.data.participants[1].matches('bot-.*')
      );
      // Users can create DMs if they are one of the participants
      // Also allow creating DMs with bot participants for demo purposes
      allow create: if isSignedIn() && (
        request.auth.uid in request.resource.data.participants ||
        request.resource.data.participants[0].matches('bot-.*') ||
        request.resource.data.participants[1].matches('bot-.*')
      );
      // Users can update DMs if they are a participant (for updating lastActivity)
      // Also allow updating DMs with bot participants
      allow update: if isSignedIn() && (
        request.auth.uid in resource.data.participants ||
        resource.data.participants[0].matches('bot-.*') ||
        resource.data.participants[1].matches('bot-.*')
      );
    }
  }
}
